<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>persisted-queries-link-with-graphql</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p><span data-css-15b13by="" aria-hidden="false">Get started</span></p>
<p><span data-css-15b13by="" aria-hidden="false">Log in</span></p>
<p><img src="../../pluralsight.imgix.net/author/lg/7aa57bc1-6266-4719-a497-c3ab18a28f5d.png" alt="Author avatar" class="jsx-3841407315" /></p>
<p>Benney Au</p>
<h1 id="persisted-queries-link-with-graphql">Persisted Queries Link with GraphQL</h1>
<h3 id="benney-au">Benney Au</h3>
<ul>
<li><p>Sep 29, 2020</p></li>
<li><p>4 Min read</p></li>
<li><p>1,712 Views</p></li>
<li><p>Sep 29, 2020</p></li>
<li><p><span class="jsx-3759398792" itemprop="timeRequired">4 Min</span> read</p></li>
<li><p>1,712 Views</p></li>
</ul>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Data</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">GraphQL</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Data Query Languages</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Data Development</span></p>
<p>Introduction</p>
<p>6</p>
<ul>
<li><a href="#module-introduction" class="menu-link">Introduction</a></li>
<li><a href="#module-howpersistedqueriesworks" class="menu-link">How Persisted Queries Works</a></li>
<li><a href="#module-enablingautomaticpersistedqueriesinaclient" class="menu-link">Enabling Automatic Persisted Queries in a Client</a></li>
<li><a href="#module-conclusion" class="menu-link">Conclusion</a></li>
<li><a href="#top" class="menu-link">Top</a></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>GraphQL provides an expressive language to specify exactly what resources and data you want to fetch. However, this can lead to a problem where clients send large payloads of query text hundreds of times larger than the REST equivalent.</p>
<p>This guide will demonstrate how to use <em>Automatic Persisted Queries</em> to solve this issue. A previous guide, <a href="https://app.pluralsight.com/guides/how-to-set-up-graphql-in-a-react-app">How to Set Up GraphQL in a React App</a>, covered how to set up a new React Project with GraphQL using Apollo Client. This guide builds on what you learned there. Here you will learn how to improve network performance by sending smaller GraphQL requests.</p>
<h2 id="how-persisted-queries-works">How Persisted Queries Works</h2>
<p>Normally, when you make a GraphQL request over HTTP, you POST a large amount of text specifying all the resources and fields you want. If there are a lot of users and resources, this can lead to network performance issues. The Apollo Client and Server implements a feature called Automatic Persisted Queries. This feature works by hashing the query, i.e., applying a function over the large query text to produce a much smaller mathematically linked valueâ€”the hash. This smaller hash is then sent to the server instead of the large query text.</p>
<p>The first time Apollo Server receives the hash, it responds by informing the client to send whole query text. The client sends the full query text, allowing the server to associate the hash with the query text. On all future queries of the same kind, even from different users, the client sends the small hash, and the server looks up the hash and knows which is being requested without it being sent explicitly over the network. In this way, a lot of network traffic is reduced.</p>
<p><strong>Note</strong>: Persisted Queries is not part of the <a href="http://spec.graphql.org/draft/">GraphQL Specification</a>. In fact, the specification is not prescriptive about what transport method is used to send the request and deliver the response. The specification only describes the query language and the execution engine. This means that all server implementations may not support Automatic Persisted Queries. <a href="https://www.apollographql.com/docs/apollo-server/performance/apq/">The Apollo Server</a> provides this feature out of the box without any configuration. However, if you are using a <a href="https://github.com/graphql-dotnet/server">graphql-dotnet</a> as your server, you will need to add a third-party package like <a href="https://www.nuget.org/packages/GraphQL.PersistedQueries/">GraphQL.PersistedQueries</a> to add support for Automatic Persisted Queries.</p>
<h2 id="enabling-automatic-persisted-queries-in-a-client">Enabling Automatic Persisted Queries in a Client</h2>
<p>If you are using Apollo Server and Apollo Client, the only thing you need to update is your client. To do this, add <span class="jsx-3120878690"><code>link</code></span>, which customizes the flow of data from your graphQL queries and mutations to your backend.</p>
<p>Run the following command to install Persisted Queries link:</p>
<pre><code>1yarn add apollo-link-persisted-queries</code></pre>
<p>Then update your <span class="jsx-3120878690"><code>src/ApolloClient/client.js</code></span> file to:</p>
<pre><code>1import { createPersistedQueryLink } from &quot;apollo-link-persisted-queries&quot;;
2import { ApolloClient, ApolloLink, InMemoryCache } from &quot;@apollo/client&quot;;
3import { HttpLink } from &quot;apollo-link-http&quot;;
4
5const httpLink = new HttpLink({
6  uri: &quot;https://48p1r2roz4.sse.codesandbox.io&quot;,
7});
8
9export const client = new ApolloClient({
10  cache: new InMemoryCache(),
11  link: ApolloLink.from([createPersistedQueryLink(), httpLink]),
12});</code></pre>
<p>javascript</p>
<p>You have updated the link chain, placing <span class="jsx-3120878690"><code>createPersistedQueryLink()</code></span> before the <span class="jsx-3120878690"><code>httpLink</code></span>. The persisted link cannot be the last in your list. No other changes should be required. Finally, start React and make a query. If the server has seen your query before, the request payload will look something like this:</p>
<pre><code>1{
2  &quot;operationName&quot;:&quot;GetExchangeRates&quot;,
3  &quot;variables&quot;:{},
4  &quot;extensions&quot;:{
5    &quot;persistedQuery&quot;: {
6      &quot;version&quot;:1,
7      &quot;sha256Hash&quot;:&quot;a14a78df14b12400059895968ef375948d2ed45da8748495d7f75368a4ac2bd1&quot;
8    }
9  }
10}</code></pre>
<p>json</p>
<h2 id="conclusion">Conclusion</h2>
<p>Interacting with remote data is a large component of modern web apps. Using Apollo and GraphQL, querying data from REST and GraphQL endpoints becomes much easier. You have learned how to make your queries more efficient. As a next step, you may want to explore other Apollo features such as <a href="https://www.apollographql.com/docs/react/data/mutations/">mutations</a> and <a href="javascript:void(0)">subscription</a>.</p>
<p>6</p>
<p><a href="https://www.pluralsight.com/product/paths"><span data-css-15b13by="" aria-hidden="false">LEARN MORE</span></a></p>
</body>
</html>
