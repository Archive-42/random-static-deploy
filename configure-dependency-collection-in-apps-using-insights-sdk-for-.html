<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>configure-dependency-collection-in-apps-using-insights-sdk-for-</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p><span data-css-15b13by="" aria-hidden="false">Get started</span></p>
<p><span data-css-15b13by="" aria-hidden="false">Log in</span></p>
<p><img src="../../pluralsight.imgix.net/author/lg/7aa57bc1-6266-4719-a497-c3ab18a28f5d.png" alt="Author avatar" class="jsx-3841407315" /></p>
<p>Benney Au</p>
<h1 id="configure-dependency-collection-using-insights-sdk-for-.net-in-azure">Configure Dependency Collection Using Insights SDK for .NET in Azure</h1>
<h3 id="benney-au">Benney Au</h3>
<ul>
<li><p>Oct 20, 2020</p></li>
<li><p>5 Min read</p></li>
<li><p>2,439 Views</p></li>
<li><p>Oct 20, 2020</p></li>
<li><p><span class="jsx-3759398792" itemprop="timeRequired">5 Min</span> read</p></li>
<li><p>2,439 Views</p></li>
</ul>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Data</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Microsoft Azure</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Data Analytics</span></p>
<p><span class="jsx-3759398792"></span></p>
<p><span data-css-1997kh1="">Cloud Platforms</span></p>
<p>Introduction</p>
<p>8</p>
<ul>
<li><a href="#module-introduction" class="menu-link">Introduction</a></li>
<li><a href="#module-howdependencycollectionworksinnetapplications" class="menu-link">How Dependency Collection Works in .NET Applications</a></li>
<li><a href="#module-customizedependencycollection" class="menu-link">Customize Dependency Collection</a></li>
<li><a href="#module-createatelemetryprocessortoconditionallyfiltertelemetry" class="menu-link">Create a Telemetry Processor to Conditionally Filter Telemetry</a></li>
<li><a href="#module-conclusion" class="menu-link">Conclusion</a></li>
<li><a href="#top" class="menu-link">Top</a></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>Application Insights SDK for .NET offers powerful dependency collection capabilities. However, sometimes it can log too much information. Since Application Insights and Azure Monitor charge per GB of data ingestion, if your application’s dependency collection is not configured correctly, your monthly Azure bill may be much higher than what it should be.</p>
<p>In this guide, you will learn how to customize Application Insights SDK for .NET to toggle different dependency collection capabilities and write a custom <span class="jsx-3120878690"><code>TelemetryProcessor</code></span> to filter out telemetry, which can reduce the amount of telemetry your application emits and lower your data ingestion costs.</p>
<h2 id="how-dependency-collection-works-in-.net-applications">How Dependency Collection Works in .NET Applications</h2>
<p>.NET offers two powerful features for collecting data about your application. These include:</p>
<ul>
<li><strong>Diagnostic Source</strong>, a feature that allows libraries to publish messages such as instrumentation that other packages can listen to and even modify. Application Insights can automatically track dependencies to supported targets since these libraries implement Diagnostic Source publishers. Using this hook, it can read messages, enrich them with extra data, and log them.</li>
<li><strong>Event Source</strong>, a similar feature that can publish low-level events that other tools and libraries can use. These tools are not able to modify data in the context of your application like Diagnostic Source. Some examples of event source data that can be collected include SQL requests, garbage collection (GC) statistics, and memory allocations.</li>
</ul>
<p>Azure Application Insights SDKs for .NET uses these two features to track and log dependency information for your application from <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/auto-collect-dependencies">supported targets</a>.</p>
<h2 id="customize-dependency-collection">Customize Dependency Collection</h2>
<p>If you are using ASP.NET Core with the <span class="jsx-3120878690"><code>Microsoft.ApplicationInsights.AspnetCore</code></span> package, there are a few global options you can configure to customize what information is logged.</p>
<pre><code>1services.ConfigureTelemetryModule&lt;DependencyTrackingTelemetryModule&gt;((module, options) =&gt;
2{
3    // disable all dependency collection
4    module.DisableDiagnosticSourceInstrumentation = false;
5
6    // disable command text
7    module.EnableSqlCommandTextInstrumentation = false;
8});</code></pre>
<p>cshsarp</p>
<p>You can use the <span class="jsx-3120878690"><code>ConfigureTelementryModule</code></span> to globally disable SQL Text capture and all dependency collection. The SQL text can sum to a large amount of data, especially if your application is very chatty with a database.</p>
<blockquote>
<p><strong>Note:</strong> Version 2.14.0 of the SDK has <a href="https://github.com/microsoft/ApplicationInsights-Announcements/issues/28">disabled command text collection by default</a>.</p>
</blockquote>
<h2 id="create-a-telemetry-processor-to-conditionally-filter-telemetry">Create a Telemetry Processor to Conditionally Filter Telemetry</h2>
<p>Rather than customize dependency collection globally, you can use <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/api-filtering-sampling">telemetry processors</a> to filter telemetry conditionally.</p>
<p>This feature allows you to inspect all telemetry inside your application and decide whether it should be logged or not.</p>
<p>If your application polls another service because it implements health checks or needs to check to maintain a singleton lock or active connection to a queue, then you will be publishing a lot of meaningless dependency logs to Application Insights.</p>
<pre><code>1/// filters out dependencies like polling queues that are not attached to any larger operation.
2public class AzureDependencyFilterTelemetryProcessor : ITelemetryProcessor
3{
4    private readonly ITelemetryProcessor _inner;
5
6    public AzureDependencyFilterTelemetryProcessor(ITelemetryProcessor inner)
7    {
8        _inner = inner;
9    }
10
11    public void Process(ITelemetry item)
12    {
13        if (item is Microsoft.ApplicationInsights.DataContracts.DependencyTelemetry dependency
14            &amp;&amp; dependency.Success == true
15            &amp;&amp; dependency.Context.Operation.Name == null
16            &amp;&amp; (dependency.Type == &quot;Azure Service Bus&quot;
17                || dependency.Type == &quot;Azure table&quot;
18                || dependency.Type == &quot;Azure blob&quot;
19                || dependency.Type == &quot;Azure queue&quot;))
20        {
21            return;
22        }
23
24        _inner.Process(item);
25    }
26}</code></pre>
<p>csharp</p>
<p>The code snippet above demonstrates how you can filter out these low-value dependency events. If your application is polling a queue to check for new messages, this task will not be part of an operation. You can use <span class="jsx-3120878690"><code>operation.Context.Operation.Name ==                                       null</code></span> to check whether the dependency was called in the context of processing an incoming HTTP request or background message or not. If the dependency is part of an operation, then you may want to keep those dependency traces.</p>
<p>Finally, you need to register your the <span class="jsx-3120878690"><code>TelemetryProcessor</code></span> with the IoC container.</p>
<pre><code>1services.AddApplicationInsightsTelemetryProcessor&lt;AzureDependencyFilterTelemetryProcessor&gt;();</code></pre>
<p>csharp</p>
<p>By filtering these dependency traces, you can reduce the number of events collected by hundreds of thousands of events if your application subscribes to many different queues.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Application Insights provides a rich set of capabilities for monitoring, logging, and diagnostics. If you are curious about some of the low-level details, you can learn more by reading <a href="https://medium.com/prospa-engineering/how-azures-application-insights-correlates-telemetry-a73731f30bbd">How Azure’s Application Insights correlates telemetry</a>.</p>
<p>8</p>
<p><a href="https://www.pluralsight.com/product/paths"><span data-css-15b13by="" aria-hidden="false">LEARN MORE</span></a></p>
</body>
</html>
